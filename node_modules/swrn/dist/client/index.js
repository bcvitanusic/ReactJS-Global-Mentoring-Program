'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.routeLoader = undefined;

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _router = require('swrn/router');

var _app = require('../lib/app');

var _app2 = _interopRequireDefault(_app);

var _loader = require('../lib/loader');

var _loader2 = _interopRequireDefault(_loader);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//获取服务器数据
var dataObj = document.getElementById('data');
var serverData = JSON.parse(dataObj.getAttribute("data-state"));
dataObj.remove();

var routeLoader = exports.routeLoader = void 0;

exports.default = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3() {
    var Main, Component, initialProps, assetPrefix, route, routes, data, props;
    return _regenerator2.default.wrap(function _callee3$(_context3) {
        while (1) {
            switch (_context3.prev = _context3.next) {
                case 0:
                    Main = void 0, Component = void 0, initialProps = {};
                    assetPrefix = serverData.assetPrefix, route = serverData.route, routes = serverData.routes;


                    exports.routeLoader = routeLoader = new _loader2.default(assetPrefix);

                    window.__SWRN_LOADED_PAGE__.forEach(function (_ref2) {
                        var route = _ref2.route,
                            fn = _ref2.fn;

                        routeLoader.registerPage(route, fn);
                    });
                    delete window.__SWRN_LOADED_PAGE__;

                    window.__SWRN_REGISTER_PAGE__ = function () {
                        var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(route, fn) {
                            return _regenerator2.default.wrap(function _callee$(_context) {
                                while (1) {
                                    switch (_context.prev = _context.next) {
                                        case 0:
                                            routeLoader.registerPage(route, fn);

                                        case 1:
                                        case 'end':
                                            return _context.stop();
                                    }
                                }
                            }, _callee, undefined);
                        }));

                        return function (_x, _x2) {
                            return _ref3.apply(this, arguments);
                        };
                    }();

                    _context3.next = 8;
                    return routeLoader.loadPage('/main.js');

                case 8:
                    Main = _context3.sent;
                    _context3.next = 11;
                    return routeLoader.loadPage(route);

                case 11:
                    Component = _context3.sent;
                    data = (0, _extends3.default)({}, serverData);
                    props = { data: data, routeLoader: routeLoader };


                    if (!!Main) {
                        props.Main = Main;
                        props.Component = Component;
                    } else {
                        props.Main = Component;
                    }

                    render(props);

                    // 路由切换页面加载
                    routeLoader.subscribe(function () {
                        var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(_ref5) {
                            var Component = _ref5.Component,
                                route = _ref5.route;
                            return _regenerator2.default.wrap(function _callee2$(_context2) {
                                while (1) {
                                    switch (_context2.prev = _context2.next) {
                                        case 0:
                                            if (Component.getInitialProps) {
                                                _context2.next = 4;
                                                break;
                                            }

                                            _context2.t0 = {};
                                            _context2.next = 7;
                                            break;

                                        case 4:
                                            _context2.next = 6;
                                            return Component.getInitialProps();

                                        case 6:
                                            _context2.t0 = _context2.sent;

                                        case 7:
                                            initialProps = _context2.t0;


                                            props.data = (0, _extends3.default)({}, initialProps, { assetPrefix: assetPrefix, route: route, routes: routes });

                                            if (!!Main) {
                                                props.Component = Component;
                                            } else {
                                                props.Main = Component;
                                            }
                                            render(props);

                                        case 11:
                                        case 'end':
                                            return _context2.stop();
                                    }
                                }
                            }, _callee2, undefined);
                        }));

                        return function (_x3) {
                            return _ref4.apply(this, arguments);
                        };
                    }());

                case 17:
                case 'end':
                    return _context3.stop();
            }
        }
    }, _callee3, undefined);
}));


function render() {
    var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    _reactDom2.default.render(_react2.default.createElement(_app2.default, props), document.getElementById('root'));
}